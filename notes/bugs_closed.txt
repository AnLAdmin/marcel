FIXED

1: ls should render files as relative to the requested directory

E.g. ls /tmp should show file_in_tmp, not /tmp/file_in_tmp.

What bash does:

- ls -l one directory: files are relative to that directory

- ls -l multiple directories: Listing looks like this:

     dir1:
     <ls -l listing relative to dir1>

     dir2:
     <ls -l listing relative to dir2>

I don't like that highly formatted listing (for multiple
directories). So for one directory, make the listing relative. For
multiple directories, list absolute paths.

----------------------------------------------------------------------

FIXED

2: Line wrapping is broken, (when typing commands)

See GNU readline horizontal-scroll-mode.
https://tiswww.cwru.edu/php/chet/readline/rluserman.html#SEC10

I think this is fixed (see util.py). But if not, I was about to send
this to stackoverflow:

I am implementing a shell with some novel features, in Python 3. My code uses the input() function and readline module to read command lines, support command history, line editing, and so on. I'm passing a prompt, which includes ANSI escape codes (for color) to the input function, and things are mostly working.

But occasionally, something will go wrong:

- Only a prefix of the prompt is printed.

- If I recall a command and edit it, the editing goes to the wrong position within the line.

- Sometimes, typing a long line, wrapping will occur far too early, before the end of the terminal line is reached.

These problems are not highly reproducible. However, so far, it appears that omitting the ANSI escapes from the prompt fixes the problem.

I have googled this problem extensively, and the closest match I've been able to locate is this: https://stackoverflow.com/questions/17432993/adding-ansi-color-escape-sequences-to-a-bash-prompt-results-in-bad-cursor-positi. But this seems to be a different problem. (My problem seems involves input(), the readline module, and the underlying GNU readline library, not bash.)

I'm looking for advice on a direction to pursue.

----------------------------------------------------------------------

FIXED

3. Getting the group of some gids kills the shell

M jao@cheese:~$ ls -fr /opt
Traceback (most recent call last):
  File "/home/jao/git/osh2/src/osh/main.py", line 45, in <module>
    main()
  File "/home/jao/git/osh2/src/osh/main.py", line 41, in main
    process_input(run_command)
  File "/home/jao/git/osh2/src/osh/main.py", line 26, in process_input
    handle_line(line)
  File "/home/jao/git/osh2/src/osh/main.py", line 15, in run_command
    command.execute()
  File "/home/jao/git/osh2/src/osh/core.py", line 238, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/osh2/src/osh/core.py", line 198, in receive
    self.first_op.receive(x)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 109, in receive
    self.visit(file, 0)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  [Previous line repeated 1 more time]
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 131, in visit
    self.send_path(path)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 144, in send_path
    self.send(file)
  File "/home/jao/git/osh2/src/osh/core.py", line 100, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/osh2/src/osh/core.py", line 115, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/osh2/src/osh/op/out.py", line 90, in receive
    out = out.render_full(self.use_color())
  File "/home/jao/git/osh2/src/osh/object/file.py", line 91, in render_full
    line = self._formatted_metadata()
  File "/home/jao/git/osh2/src/osh/object/file.py", line 131, in _formatted_metadata
    '{:8s}'.format(groupname(self.gid)),
  File "/home/jao/git/osh2/src/osh/util.py", line 17, in groupname
    return grp.getgrgid(gid).gr_name
KeyError: 'getgrgid(): gid not found: 143'

----------------------------------------------------------------------

FIXED

4. Receive_complete called too many times following remote fork

@jao [ gen 3 ] | red . +

Should produce (localhost, 3). But it produces that output TWICE.

----------------------------------------------------------------------

FIXED

5. Unspecified behavior for red

red . + does something given inputs of size 3. What is supposed to
happen? Document and test for it.

----------------------------------------------------------------------

FIXED

6. File.render_full should include date/time

Linux does (day, month, time) for recent, (day, month, year) for
older. 

E.g.

lrwxrwxrwx 1 root   root          31 Feb 26  2019  x-www-browser -> /etc/alternatives/x-www-browser
-rwxr-xr-x 1 root   root       18712 Sep  5 07:15  xxd

----------------------------------------------------------------------

FIXED

7. assert x is None in op.recieve() is a problem

Incorrect usage, such as "ls | bash emacs" causes the assertion to
fail and kills the shell. Should be a usage error instead.


----------------------------------------------------------------------

Oops, there are two bug 8s.

FIXED

8a. Fix rendering of links

- Color schema shows link using same color as directory in
  prompt. Confusing.

- Show link and target (different colors)


FIXED

8b. Highlighting confusion

If a directory (or file) matches the name of an executable, then the
highlighting is wrong. It is highlighted as an executable, not what it
really is.

----------------------------------------------------------------------

FIXED

9. Syntax error in map function not handled correctly

M jao@cheese:~/git/marcel/src/marcel$ ps | map (p: (p.pid, p.commandline.split()[0] if p.commandline else '')
Caught <class 'SyntaxError'>: invalid syntax (<string>, line 1)
  File "/home/jao/git/marcel/src/marcel/core.py", line 24, in arg_checker
    return check_and_convert(s)
  File "/home/jao/git/marcel/src/marcel/core.py", line 40, in check_function
    return marcel.function.Function(s)
  File "/home/jao/git/marcel/src/marcel/function.py", line 26, in __init__
    self.create_function()
  File "/home/jao/git/marcel/src/marcel/function.py", line 68, in create_function
    self.function = eval('lambda: ' + self.source, env.globals())
usage: map [-h] function
map: error: argument function: not a valid function

- There shouldn't be a stack, just an error message.

----------------------------------------------------------------------

FIXED

10. sort all by itself produces None as output

This seems wrong:

     M jao@cheese:~/git/marcel$ sort
     None

----------------------------------------------------------------------

FIXED

11. ls () works?!

M jao@cheese:~/git/marcel$ ls ()
drwxr-xr-x   jao      jao              4096   2020 Feb 25 15:33:00   .
drwxr-xr-x   jao      jao              4096   2020 Feb 26 23:43:50   .git
-rw-r--r--   jao      jao                20   2020 Jan 24 17:07:26   .gitignore
drwxr-xr-x   jao      jao              4096   2020 Feb 26 23:59:32   .idea
-rw-r--r--   jao      jao              6420   2020 Feb 25 15:59:14   README.md
drwxr-xr-x   jao      jao              4096   2020 Feb 25 11:22:15   bin
drwxr-xr-x   jao      jao              4096   2020 Feb 21 13:22:22   experiments
drwxr-xr-x   jao      jao              4096   2020 Feb 26 09:35:03   notes
drwxr-xr-x   jao      jao              4096   2020 Feb 19 10:31:26   src
drwxr-xr-x   jao      jao              4096   2020 Feb 25 09:38:13   test

----------------------------------------------------------------------

FIXED

12. Arguments to bash executable not being processed?

jao@cheese:~/git/marcel$ bash -i less README.md
Missing filename ("less --help" for help)
M jao@cheese:~/git/marcel$ bash -i ls *.md
bin  experiments  notes  README.md  src  test
M jao@cheese:~/git/marcel$ bash -i which which
Escaped command failed with exit code 1: which which
None

----------------------------------------------------------------------

FIXED

13. Tab completion for op isn't working after the first op in a pipeline

----------------------------------------------------------------------

FIXED

14. Tab expansion for files doesn't work if path starts with ~

----------------------------------------------------------------------

FIXED

15. File expansion not working for path beginning with ~/

E.g.

  M jao@cheese:~/git/marcel/src/marcel$ ls ~/ac

(There are two files whose names start with "ac")

----------------------------------------------------------------------

FIXED

16. Permission error on rm of directory crashes shell

M jao@cheese:/tmp$ rm rd
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 88, in <module>
    Main().run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 58, in run
    Main.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 70, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 36, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 209, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 51, in receive
    Rm.remove(root)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 67, in remove
    shutil.rmtree(root)
  File "/usr/lib/python3.7/shutil.py", line 498, in rmtree
    onerror(os.rmdir, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 496, in rmtree
    os.rmdir(path)
PermissionError: [Errno 1] Operation not permitted: '/tmp/rd'

----------------------------------------------------------------------

FIXED (accidentally)

17. Tab completion for filenames with spaces and escapes

E.g., tab completion for a\ b doesn't work.


----------------------------------------------------------------------

FIXED

18. Following restart, multilines history is wrong

A multiline command is recalled one line at a time.

----------------------------------------------------------------------

FIXED

19. Crash on first run of marcel if .marcel_history doesn't exist


----------------------------------------------------------------------

FIXED

20. edit op isn't working

Wasn't quite finished.


----------------------------------------------------------------------

FIXED

21. Prompt directory stuck at ~

The problem is that the value of PWD is copied into the .marcel.py
global namespace. Need to implement a Variable class, and put it in
that namespace. The Variable can then be updated by Environment.cd.

I.e., the Variable can be shared between Environment and the config
namespace, but values cannot.

----------------------------------------------------------------------

FIXED

22. Error output should be more informative

M jao@cheese:~$ gen 3 -1 | map (x: 1/x)
-1.0
Error(None)
1.0

Error(None): should identify input and op

----------------------------------------------------------------------

FIXED

25. ls causes marcel to crash

M jao@cheese:~$ ls -r snap

...
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:02   spotify/36/.local/share/icons
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:12   spotify/36/.local/share/icons/Adwaita
lrwxrwxrwx   jao      jao                46   2019 Aug 11 18:30:02   spotify/36/.local/share/icons/Adwaita/16x16 -> /snap/spotify/36/usr/share/icons/Adwaita/16x16
drwxr-xr-x   root     root              965   2019 Jul 17 13:34:47   spotify/36/.local/share/icons/Adwaita/16x16/actions
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 111, in receive
    self.visit(root, 0, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  [Previous line repeated 6 more times]
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 124, in visit
    self.send_path(root, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 138, in send_path
    self.send(file)
  File "/home/jao/git/marcel/src/marcel/core.py", line 111, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/marcel/src/marcel/core.py", line 126, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/marcel/src/marcel/op/out.py", line 78, in receive
    out = out.render_full(self.color_scheme())
  File "/home/jao/git/marcel/src/marcel/object/file.py", line 62, in render_full
    line[-1] = colorize(line[-1], self._highlight_color(self, color_scheme))
  File "/home/jao/git/marcel/src/marcel/util.py", line 88, in colorize
    1 if color.bold else 0,
AttributeError: 'str' object has no attribute 'bold'


----------------------------------------------------------------------

FIXED

26. Symlink target always displayed as absolute

It should be displayed however it is stored. 

marcel:

    M jao@cheese:/usr/bin$ ls xzcat
    lrwxrwxrwx   root     root                2   2019 Jan 27 20:09:34   /usr/bin/xzcat -> /usr/bin/xz

bash:

    jao@cheese:/usr/bin$ ls -l xzcat
    lrwxrwxrwx 1 root root 2 Jan 27  2019 xzcat -> xz

----------------------------------------------------------------------

FIXED

27. Shell crashes on some pathlib operations if current dir does not exist

cd from current dir:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/cd.py", line 45, in receive
    dir = self.directory.expanduser().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1151, in resolve
    s = self._flavour.resolve(self, strict=strict)
  File "/usr/lib/python3.7/pathlib.py", line 354, in resolve
    base = '' if path.is_absolute() else os.getcwd()
FileNotFoundError: [Errno 2] No such file or directory


Start marcel from dir that was deleted:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 121, in <module>
    MAIN = Main()
  File "/home/jao/git/marcel/src/marcel/main.py", line 59, in __init__
    self.env = marcel.env.Environment(config_path)
  File "/home/jao/git/marcel/src/marcel/env.py", line 19, in __init__
    self._current_dir = pathlib.Path.cwd().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1064, in cwd
    return cls(os.getcwd())
FileNotFoundError: [Errno 2] No such file or directory


----------------------------------------------------------------------

FIXED

28. Hang on command with extra )

The last command hangs when an extra ) is added to the end.

M jao@cheese:/tmp/test$ ls
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:51   .
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:30   d
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   lf
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sd -> /tmp/test/d
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sf -> /tmp/test/f
M jao@cheese:/tmp/test$ ls f g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   /tmp/test/f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   /tmp/test/g
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size))
('f', 2)
('g', 5)
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size)))
^C

----------------------------------------------------------------------

FIXED

29. Fork execution of ls is broken

Remote:

    M jao@cheese:~$ @jao [ ls /home/jao ]
    M jao@cheese:~$ 

No output at all.

Local:

    M jao@cheese:~$ @1 [ ls /home/jao ]
    Traceback (most recent call last):
      File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
        self.run_command(line)
      File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
        Command(pipeline).execute()
      File "/home/jao/git/marcel/src/marcel/main.py", line 38, in execute
        self.pipeline.setup_2()
      File "/home/jao/git/marcel/src/marcel/core.py", line 228, in setup_2
        op.setup_2()
      File "/home/jao/git/marcel/src/marcel/op/fork.py", line 76, in setup_2
        pipeline_copy.setup_1()
      File "/home/jao/git/marcel/src/marcel/core.py", line 217, in setup_1
        op.setup_1()
      File "/home/jao/git/marcel/src/marcel/op/ls.py", line 93, in setup_1
        super().setup_1()
      File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 35, in setup_1
        self.current_dir = self.env().pwd()
    AttributeError: 'GlobalState' object has no attribute 'env'

----------------------------------------------------------------------

FIXED

30. cd broken

M jao@cheese:~/git/marcel$ cd
Cannot cd into /home/jao/git/marcel/~. Directory does not exist.

----------------------------------------------------------------------

FIXED

31. ls /no/such/path appears to work

/no/such/path evaluates to an empty root, so the command is basically
"ls" and we get the files in the current directory.

----------------------------------------------------------------------

FIXED

32. ls crashes shell on PermissionError

M jao@cheese:~/git/marcel$ ls ~/.dbus/session-bus 
drwx------   root     root             4096   2019 Mar 28 23:45:10   .
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 126, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 81, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 93, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 28, in receive
    self.action(root)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 120, in action
    self.visit(source, 0)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 127, in visit
    for file in sorted(root.iterdir()):
  File "/usr/lib/python3.7/pathlib.py", line 1090, in iterdir
    for name in self._accessor.listdir(self):
PermissionError: [Errno 13] Permission denied: '/home/jao/.dbus/session-bus'


----------------------------------------------------------------------

FIXED

33. > in command line doesn't work

M jao@cheese:~/git/marcel$ git diff > /tmp/m.diff
Error(error: Could not access '>')



----------------------------------------------------------------------

FIXED

35. Completed jobs accumulate in jobs output

JobControl.jobs shouldn't be exposed directly. Go through a method
that calls remove_completed.

----------------------------------------------------------------------

FIXED

36. Duplicated output when grep is invoked

This is odd:

    M jao@cheese:~/git/marcel/test$ echo hello
    hello
    M jao@cheese:~/git/marcel/test$ echo hello | grep hello
    hello
    hello


----------------------------------------------------------------------

FIXED

37. kill op only kills

It ignores the signal, and just kills the command. What is the correct
behavior? kill is implemented by SIGTERM, not SIGTERM, as usual. Maybe
SIGTERM would work? Haven't tried it. If SIGTERM works instead of
SIGKILL, then switch to it, and have the kill op work consistently
with bash.

----------------------------------------------------------------------

FIXED

38. Wildcard not working

M jao@cheese:~$ grep MiniMachete /var/log/syslog*
Error(grep: /var/log/syslog*: No such file or directory)

----------------------------------------------------------------------

FIXED

39. Incorrect wrapping of help text

From red.DETAILS:

'''
...
If this sequence is piped to this invocation of {red}:

    red . + . +

then groups are defined using the first and third values, {(1, 10), (1, 11), (2, 20), (3, 30)}.
The output would be:

    (1, 11, 10, 300)
...
'''

Formatted:

If this sequence is piped to this invocation of red:

    red . + . +

then groups are defined using the first and third values, (1, 10), (1, 11), (2, 20), (3, 30). The output would be:

    (1, 11, 10, 300)


Why isn't the "then groups ..." text wrapped?

----------------------------------------------------------------------

40. Unknown cluster name is assumed to be an int

M jao@cheese:~/git/marcel/test$ @local [ ps | select (p: 'python' in p.commandline) ]
Process Process-3:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/src/marcel/job.py", line 130, in run_command
    env_vars = command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 40, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/src/marcel/core.py", line 276, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 45, in setup_1
    self.impl = Remote(self) if cluster else Local(self)
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 176, in __init__
    op.fork_spec = int(op.fork_spec)
ValueError: invalid literal for int() with base 10: 'local'


----------------------------------------------------------------------

FIXED

41. Blank line should not be ignored on continuation line

Blank lines are ignored, which is fine. But if the blank line is a
continuation line, then the current command should be ended and executed.
Cleanup:

----------------------------------------------------------------------

NOT A BUG: echo doesn't accept piped input. And ... | xargs echo works.

42. Errors piped to executables are broken

Odd results:

M jao@cheese:/etc/sysctl.d$ gen 3 | map (x: 1/(1-x)) | echo
Error(map(x: 1/(1-x)) failed on (1,): division by zero)

----------------------------------------------------------------------

NOT A BUG: Yes, crashing the shell is fine. Bad markup is a bug in source, users shouldn't see it.

43. Bad markup shouldn't crash the shell

And probably don't throw Exception.

M jao@cheese:~$ help configuration
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 159, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 90, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 107, in run_command
    command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 41, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 292, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 52, in receive
    help_text = Help.op_help(op_module) if op_module else self.topic_help()
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 81, in topic_help
    return formatter.format(help_text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 298, in format
    blocks = self.find_explicit_paragraph_boundaries(text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 321, in find_explicit_paragraph_boundaries
    blocks.append(Paragraph(self, text[open:close]))
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 208, in __init__
    self.paragraph_markup = ParagraphMarkup(markup)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 85, in __init__
    self.parse_paragraph_formatting()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 91, in parse_paragraph_formatting
    self.raise_invalid_formatting_exception()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 74, in raise_invalid_formatting_exception
    raise Exception(f'Invalid formatting specification: {self.text}')
Exception: Invalid formatting specification: {process_...}


----------------------------------------------------------------------

FIXED

44. \ in help text doesn't work.

\\ in help_command.py: Need space between \\ and } or crash. Also, not
even \\ is showing up.

----------------------------------------------------------------------

45. Tab completion on "ls -l" (I think)

M-0.6.3 jao@cheese:~/git/marcel$ ls -l test/test_opusage: ls [-h] [-0 | -1 | -r] [-f] [-d] [-s] ...
Caught <class 'marcel.exception.KillCommandException'>: ls: error: unrecognized arguments: -l

  File "/home/jao/git/marcel/marcel/tabcompleter.py", line 73, in complete
    parser.parse(partial_text=True)
  File "/home/jao/git/marcel/marcel/parse.py", line 443, in parse
    self.args_action(token)
  File "/home/jao/git/marcel/marcel/parse.py", line 417, in args_action
    self.finish_op()
  File "/home/jao/git/marcel/marcel/parse.py", line 513, in finish_op
    arg_parser.parse_args(current.args, namespace=op)
  File "/home/jao/git/marcel/marcel/core.py", line 61, in parse_args
    return super().parse_args(args, namespace)
  File "/usr/lib/python3.7/argparse.py", line 1767, in parse_args
    self.error(msg % ' '.join(argv))
  File "/usr/lib/python3.7/argparse.py", line 2516, in error
    self.exit(2, _('%(prog)s: error: %(message)s\n') % args)
  File "/home/jao/git/marcel/marcel/core.py", line 68, in exit
    raise marcel.exception.KillCommandException(message)
ls: error: unrecognized arguments: -l

usage: ls [-h] [-0 | -1 | -r] [-f] [-d] [-s] ...
Caught <class 'marcel.exception.KillCommandException'>: ls: error: unrecognized arguments: -l

  File "/home/jao/git/marcel/marcel/tabcompleter.py", line 73, in complete
    parser.parse(partial_text=True)
  File "/home/jao/git/marcel/marcel/parse.py", line 443, in parse
    self.args_action(token)
  File "/home/jao/git/marcel/marcel/parse.py", line 417, in args_action
    self.finish_op()
  File "/home/jao/git/marcel/marcel/parse.py", line 513, in finish_op
    arg_parser.parse_args(current.args, namespace=op)
  File "/home/jao/git/marcel/marcel/core.py", line 61, in parse_args
    return super().parse_args(args, namespace)
  File "/usr/lib/python3.7/argparse.py", line 1767, in parse_args
    self.error(msg % ' '.join(argv))
  File "/usr/lib/python3.7/argparse.py", line 2516, in error
    self.exit(2, _('%(prog)s: error: %(message)s\n') % args)
  File "/home/jao/git/marcel/marcel/core.py", line 68, in exit
    raise marcel.exception.KillCommandException(message)
ls: error: unrecognized arguments: -l


----------------------------------------------------------------------

NOT A BUG

The ssh session was in a process. The prompt was from the main loop of the console process.
bash -i ssh ... works as expected.

46. ssh identity confusion

    M-0.6.5 jao@cheese:~$ ssh -Y z@localhost
    z@localhost's password: 
    Welcome to Pop!_OS 19.10 (GNU/Linux 5.3.0-7648-generic x86_64)
    
     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage
    
     * Ubuntu 20.04 LTS is out, raising the bar on performance, security,
       and optimisation for Intel, AMD, Nvidia, ARM64 and Z15 as well as
       AWS, Azure and Google Cloud.
    
         https://ubuntu.com/blog/ubuntu-20-04-lts-arrives
    
    New release '20.04 LTS' available.
    Run 'do-release-upgrade' to upgrade to it.
    
    M-0.6.5 jao@cheese:~$ 

Why does remote session end up in marcel, logged in as jao?

----------------------------------------------------------------------

FIXED

49. Symbol defined in config file not visible to pipeline assigned to var

M-0.7.1 jao@cheese:~/git/marcel/test$ recent = [select(f: now() - f.mtime < hours(8))]
M-0.7.1 jao@cheese:~/git/marcel/test$ (recent)
pipeline(select(f: now() - f.mtime < hours(8)))
M-0.7.1 jao@cheese:~/git/marcel/test$ ls | recent
Error(Running select(f: now() - f.mtime < hours(8)) on (.,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (.marcel.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (.marcel_bug29.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (__init__.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (__pycache__,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_28.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_29.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_30.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_31.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_33.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_38.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (bug_39.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_api.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_api2.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_base.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_embedded_python.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_filename_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_help.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_native_filename_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_ops.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_parser.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_python_string.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_shell_string.txt,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (test_tokenizing.py,): name 'now' is not defined)
Error(Running select(f: now() - f.mtime < hours(8)) on (testall,): name 'now' is not defined)

----------------------------------------------------------------------

FIXED

50. Assigning function with unbound args blows up

    M-0.7.1 jao@cheese:~$ x = (a: a + 1)
    Error(Running assign(x, None) on : <lambda>() missing 1 required positional argument: 'a')
    Traceback (most recent call last):
      File "/home/jao/git/marcel/marcel/functionwrapper.py", line 59, in __call__
        return self._function(*args, **kwargs)
    TypeError: <lambda>() missing 1 required positional argument: 'a'
    
    During handling of the above exception, another exception occurred:
    
    Traceback (most recent call last):
      File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
        "__main__", mod_spec)
      File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
        exec(code, run_globals)
      File "/home/jao/git/marcel/marcel/main.py", line 212, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/marcel/main.py", line 116, in run
        self.run_command(line)
      File "/home/jao/git/marcel/marcel/main.py", line 140, in run_command
        command.execute()
      File "/home/jao/git/marcel/marcel/core.py", line 413, in execute
        self.pipeline.setup_1()
      File "/home/jao/git/marcel/marcel/core.py", line 348, in setup_1
        op.setup_1()
      File "/home/jao/git/marcel/marcel/op/assign.py", line 48, in setup_1
        self.value = function()
      File "/home/jao/git/marcel/marcel/functionwrapper.py", line 67, in __call__
        self._op.fatal_error(function_input_string, str(e))
      File "/home/jao/git/marcel/marcel/core.py", line 255, in fatal_error
        raise marcel.exception.KillAndResumeException(error)
    marcel.exception.KillAndResumeException: Error(Running assign(x, None) on : <lambda>() missing 1 required positional argument: 'a')

Allow this? If not, then at least fail gracefully.

----------------------------------------------------------------------

FIXED

51. Crash on editing and entering line with no line continuation after \ (?)

M-0.7.3 jao@cheese:~/git/marcel$ ls -fr \
| select (f: f.suffix == '.py') \
| map (f: f.read().count('\n')) |
Traceback (most recent call last):
  File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/home/jao/git/marcel/marcel/main.py", line 210, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/marcel/main.py", line 116, in run
    self.run_command(line)
  File "/home/jao/git/marcel/marcel/main.py", line 128, in run_command
    pipeline = parser.parse()
  File "/home/jao/git/marcel/marcel/parser.py", line 560, in parse
    return self.command()
  File "/home/jao/git/marcel/marcel/parser.py", line 566, in command
    return self.pipeline()
  File "/home/jao/git/marcel/marcel/parser.py", line 586, in pipeline
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 599, in op_sequence
    op_sequence = Parser.ensure_sequence(self.op_sequence())
  File "/home/jao/git/marcel/marcel/parser.py", line 597, in op_sequence
    op_args = self.op_args()
  File "/home/jao/git/marcel/marcel/parser.py", line 609, in op_args
    op_token = self.op()
  File "/home/jao/git/marcel/marcel/parser.py", line 625, in op
    raise PrematureEndError()
marcel.parser.PrematureEndError: Command ended prematurely.

----------------------------------------------------------------------

FIXED

53. Stack trace on unexpected arg type to ls

M-0.7.6 jao@cheese:~/git/marcel$ ls (File('bin'))
Process Process-11:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 146, in run_command
    dir_vars = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 346, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 297, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/ls.py", line 111, in setup_1
    super().setup_1()
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 39, in setup_1
    self.roots = FilenamesOp.deglob(self.current_dir, self.filenames)
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 82, in deglob
    paths = FilenamesOp.normalize_paths(filenames)
  File "/home/jao/git/marcel/marcel/op/filenames.py", line 70, in normalize_paths
    filename = os.path.normpath(filename)
  File "/usr/lib/python3.7/posixpath.py", line 340, in normpath
    path = os.fspath(path)
TypeError: expected str, bytes or os.PathLike object, not File
M-0.7.6 jao@cheese:~/git/marcel$ 

----------------------------------------------------------------------

FIXED

54. "ps -u" is broken

Without a userid. Seems to work with one.

----------------------------------------------------------------------

55. Tab completion showing non-public commands

E.g. tab completion of "g" ->gather gen

gather should not be visible.

----------------------------------------------------------------------

FIXED

56. stderr not captured

M-0.7.8 jao@cheese:~$ print 'a'
M-0.7.8 jao@cheese:~$ 
jao@cheese:~$ print 'a'
"my" variable $file masks earlier declaration in same scope at /usr/bin/print line 339.
Use of uninitialized value $code in concatenation (.) or string at /usr/bin/print line 356, <READER> line 1.
Error: no such file "a"
jao@cheese:~$ 

print 'a' is a shell command which writes to stderr. Marcel doesn't
report it.

----------------------------------------------------------------------

NOT A BUG

57. This seems wrong

    M-0.7.9 jao@cheese:~/git/marcel/test$ printa
    Unknown command: printa
    M-0.7.9 jao@cheese:~/git/marcel/test$ print('a')
    printa

In bash, ls, "ls", 'l's all do the same thing.


abc('def'):

- Lexer turns this into Expression(f'''abc{'def'}''')

- Parser then makes it map(Expression(...))

abcdef:

- Parser tries to do create_op and fails.

When should Expressions be evaluated? To fix this bug, it would have
to be at parse time. But that doesn't work in general, e.g. for the
functions used by map and select.

Decide based on context. In case of an op (this bug) do it at parse
time. But we DO want an expression such as (5+6) to be evaluated at
runtime, not interpreted as an op.

I'm going to say this is not a bug.

----------------------------------------------------------------------

FIXED

59. cat can't find file that exists

Is bash not expanding ~?

M-0.7.12 jao@cheese:~/git/marcel/test$ cat ~/system76.txt
Error(cat: '~/system76.txt': No such file or directory)

----------------------------------------------------------------------

FIXED

60. Preserve quotes when passing args to bash

Quote-sensitive tests in test_ops fail otherwise.

RE-ENABLE test_bash() in test_ops once this is fixed.

----------------------------------------------------------------------

FIXED

61. runpipeline op doesn't work when first in pipeline.

Create a pipeline and use it:

    M-0.8.0 jao@cheese:~/git/marcel/test$ a = [gen 3]
    M-0.8.0 jao@cheese:~/git/marcel/test$ a
    0
    1
    2
    M-0.8.0 jao@cheese:~/git/marcel/test$ (a)
    pipeline(gen(count=3, start=0, pad=None))

Embed the pipeline in another one:

    M-0.8.0 jao@cheese:~/git/marcel/test$ b = [a]
    M-0.8.0 jao@cheese:~/git/marcel/test$ (b)
    pipeline(runpipeline(a))
    M-0.8.0 jao@cheese:~/git/marcel/test$ b
    M-0.8.0 jao@cheese:~/git/marcel/test$ 

Executing b produces no output. It should have run a.

----------------------------------------------------------------------

62. Don't crash if .marcel.py is not present

Crash isn't on startup, but on the first command. The crash is on
checking the file's mtime. 

Create an empty .marcel.py.


----------------------------------------------------------------------

FIXED

63. Wrapping of {L} tags is broken.

E.g., from red.HELP:

{L,indent=4:28}-i, --incremental       Output a tuple for each step of the reduction. I.e., there will be one
output tuple for each input tuple, with the reductions showing the result of the reduction up to and including
the most recent input.

----------------------------------------------------------------------

FIXED

65. Returning updated namespace from Job still broken

M-0.9.15 jao@cheese:~/git/marcel/test$ x = [(4)]
M-0.9.15 jao@cheese:~/git/marcel/test$ x
4
Process Process-1:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 147, in run_command_in_child
    writer.send(child_namespace_changes)
  File "/usr/lib/python3.8/multiprocessing/connection.py", line 206, in send
    self._send_bytes(_ForkingPickler.dumps(obj))
  File "/usr/lib/python3.8/multiprocessing/reduction.py", line 51, in dumps
    cls(buf, protocol).dump(obj)
_pickle.PicklingError: Can't pickle <function <lambda> at 0x7f75c4a4b550>: attribute lookup <lambda> on __main__ failed

----------------------------------------------------------------------

FIXED

68. Help formatting broken -- indent vs. wrap

This indents by 4:

    {L,indent=4}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

This does not:

    {L,indent=4,wrap=F}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

This does indent:

    {L,indent=4,wrap=T}loop ((0, 1)) [select (x, y: y < 1000000) | map (x, y: (y, x + y))] | map (x, y: x)

So wrap=F causes indent to be ignored.

----------------------------------------------------------------------

FIXED

70. Pipeline containing loop crashes when executed

M-0.9.17 jao@cheese:~/git/marcel/test$ p = [loop (0) [select (x: x < 5) | emit | map (x: x+1)]]
M-0.9.17 jao@cheese:~/git/marcel/test$ p
Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 392, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 314, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/runpipeline.py", line 49, in setup_1
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/marcel/core.py", line 314, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/marcel/op/loop.py", line 104, in setup_1
    loop_pipeline.prepend(marcel.opmodule.create_op(self.env(), 'load', self.loopvar))
  File "/home/jao/git/marcel/marcel/opmodule.py", line 83, in create_op
    op_module = env.op_modules[op_name]
AttributeError: 'Environment' object has no attribute 'op_modules'


----------------------------------------------------------------------

FIXED

71. store not setting variable

M-0.9.17 jao@cheese:~/git/marcel/test$ gen 10 | ifthen (x: x%2==0) [store d2]
0
1
2
3
4
5
6
7
8
9
M-0.9.17 jao@cheese:~/git/marcel/test$ (d2)
Error: Running map(lambda: d2): name 'd2' is not defined

----------------------------------------------------------------------

FIXED

72. Join of stored pipelines fails

cd ~/git/marcel
ls -fr marcel test \
| ifthen (f: now() - f.mtime < days(1)) [store recent] \
| ifelse (f: f.suffix == '.py') [store py] \
| ifelse (f: f.suffix == '.txt') [store txt]
load recent | join [load py]

Process Process-2:
Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
    self.run()
  File "/usr/lib/python3.8/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/marcel/job.py", line 145, in run_command_in_child
    child_namespace_changes = command.execute()
  File "/home/jao/git/marcel/marcel/core.py", line 440, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/marcel/core.py", line 373, in receive
    self.first_op.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/load.py", line 86, in receive
    self.send(next(self.input))
  File "/home/jao/git/marcel/marcel/core.py", line 158, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/join.py", line 130, in receive
    self.send(x + match[1:])
  File "/home/jao/git/marcel/marcel/core.py", line 158, in send
    receiver.receive_input(x)
  File "/home/jao/git/marcel/marcel/core.py", line 175, in receive_input
    self.receive(None if x is None else
  File "/home/jao/git/marcel/marcel/op/out.py", line 115, in receive
    out = out.render_full(self.color_scheme())
  File "/home/jao/git/marcel/marcel/object/file.py", line 96, in render_full
    line = self._formatted_metadata()
  File "/home/jao/git/marcel/marcel/object/file.py", line 151, in _formatted_metadata
    self.display_path.as_posix()]
AttributeError: 'NoneType' object has no attribute 'as_posix'


----------------------------------------------------------------------

FIXED

73. Parsing error involving pipe and/or pipeline args with load syntax

Pipe before the last join is rejected

    M-0.9.20 jao@cheese:~/git/marcel$ a > join [b>] | join [c>]
    Parsing error at position 10 of "...join [b>] | join [c>]...": Unexpected token type: Pipe(|)
    
Two successive joins not piped is OK?!

    M-0.9.20 jao@cheese:~/git/marcel$ a > join [b>] join [c>]
    (0, 0, 0, 0)
    (1, 10, 100, 1000)
    (2, 20, 200, 2000)
    (3, 30, 300, 3000)
    (4, 40, 400, 4000)

----------------------------------------------------------------------

FIXED 

74. Redirect after join fails

Setup:

    gen 5 | map (x: (x, x*10)) > a
    gen 5 | map (x: (x, x*100)) > b
    gen 5 | map (x: (x, x*1000)) > c
    

This prints the result of the join, doesn't assign to d:

    a > join[b>] | join [c>] > d

This works:

    a > join[b>] | join [c>] | store d

----------------------------------------------------------------------

FIXED

75. read is buggy, stops before end

E.g., ls ~/git/marcel/notes/grammar.txt | read
