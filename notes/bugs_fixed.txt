FIXED

1: ls should render files as relative to the requested directory

E.g. ls /tmp should show file_in_tmp, not /tmp/file_in_tmp.

What bash does:

- ls -l one directory: files are relative to that directory

- ls -l multiple directories: Listing looks like this:

     dir1:
     <ls -l listing relative to dir1>

     dir2:
     <ls -l listing relative to dir2>

I don't like that highly formatted listing (for multiple
directories). So for one directory, make the listing relative. For
multiple directories, list absolute paths.

----------------------------------------------------------------------

FIXED

2: Line wrapping is broken, (when typing commands)

See GNU readline horizontal-scroll-mode.
https://tiswww.cwru.edu/php/chet/readline/rluserman.html#SEC10

I think this is fixed (see util.py). But if not, I was about to send
this to stackoverflow:

I am implementing a shell with some novel features, in Python 3. My code uses the input() function and readline module to read command lines, support command history, line editing, and so on. I'm passing a prompt, which includes ANSI escape codes (for color) to the input function, and things are mostly working.

But occasionally, something will go wrong:

- Only a prefix of the prompt is printed.

- If I recall a command and edit it, the editing goes to the wrong position within the line.

- Sometimes, typing a long line, wrapping will occur far too early, before the end of the terminal line is reached.

These problems are not highly reproducible. However, so far, it appears that omitting the ANSI escapes from the prompt fixes the problem.

I have googled this problem extensively, and the closest match I've been able to locate is this: https://stackoverflow.com/questions/17432993/adding-ansi-color-escape-sequences-to-a-bash-prompt-results-in-bad-cursor-positi. But this seems to be a different problem. (My problem seems involves input(), the readline module, and the underlying GNU readline library, not bash.)

I'm looking for advice on a direction to pursue.

----------------------------------------------------------------------

FIXED

3. Getting the group of some gids kills the shell

M jao@cheese:~$ ls -fr /opt
Traceback (most recent call last):
  File "/home/jao/git/osh2/src/osh/main.py", line 45, in <module>
    main()
  File "/home/jao/git/osh2/src/osh/main.py", line 41, in main
    process_input(run_command)
  File "/home/jao/git/osh2/src/osh/main.py", line 26, in process_input
    handle_line(line)
  File "/home/jao/git/osh2/src/osh/main.py", line 15, in run_command
    command.execute()
  File "/home/jao/git/osh2/src/osh/core.py", line 238, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/osh2/src/osh/core.py", line 198, in receive
    self.first_op.receive(x)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 109, in receive
    self.visit(file, 0)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 135, in visit
    self.visit(file, level + 1)
  [Previous line repeated 1 more time]
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 131, in visit
    self.send_path(path)
  File "/home/jao/git/osh2/src/osh/op/ls.py", line 144, in send_path
    self.send(file)
  File "/home/jao/git/osh2/src/osh/core.py", line 100, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/osh2/src/osh/core.py", line 115, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/osh2/src/osh/op/out.py", line 90, in receive
    out = out.render_full(self.use_color())
  File "/home/jao/git/osh2/src/osh/object/file.py", line 91, in render_full
    line = self._formatted_metadata()
  File "/home/jao/git/osh2/src/osh/object/file.py", line 131, in _formatted_metadata
    '{:8s}'.format(groupname(self.gid)),
  File "/home/jao/git/osh2/src/osh/util.py", line 17, in groupname
    return grp.getgrgid(gid).gr_name
KeyError: 'getgrgid(): gid not found: 143'

----------------------------------------------------------------------

FIXED

4. Receive_complete called too many times following remote fork

@jao [ gen 3 ] | red . +

Should produce (localhost, 3). But it produces that output TWICE.

----------------------------------------------------------------------

FIXED

8. Fix rendering of links

- Color schema shows link using same color as directory in
  prompt. Confusing.

- Show link and target (different colors)


----------------------------------------------------------------------

FIXED

6. File.render_full should include date/time

Linux does (day, month, time) for recent, (day, month, year) for
older. 

E.g.

lrwxrwxrwx 1 root   root          31 Feb 26  2019  x-www-browser -> /etc/alternatives/x-www-browser
-rwxr-xr-x 1 root   root       18712 Sep  5 07:15  xxd

----------------------------------------------------------------------

FIXED

7. assert x is None in op.recieve() is a problem

Incorrect usage, such as "ls | bash emacs" causes the assertion to
fail and kills the shell. Should be a usage error instead.


----------------------------------------------------------------------

FIXED

8. Highlighting confusion

If a directory (or file) matches the name of an executable, then the
highlighting is wrong. It is highlighted as an executable, not what it
really is.

----------------------------------------------------------------------

FIXED

9. Syntax error in map function not handled correctly

M jao@cheese:~/git/marcel/src/marcel$ ps | map (p: (p.pid, p.commandline.split()[0] if p.commandline else '')
Caught <class 'SyntaxError'>: invalid syntax (<string>, line 1)
  File "/home/jao/git/marcel/src/marcel/core.py", line 24, in arg_checker
    return check_and_convert(s)
  File "/home/jao/git/marcel/src/marcel/core.py", line 40, in check_function
    return marcel.function.Function(s)
  File "/home/jao/git/marcel/src/marcel/function.py", line 26, in __init__
    self.create_function()
  File "/home/jao/git/marcel/src/marcel/function.py", line 68, in create_function
    self.function = eval('lambda: ' + self.source, env.globals())
usage: map [-h] function
map: error: argument function: not a valid function

- There shouldn't be a stack, just an error message.

----------------------------------------------------------------------

FIXED

12. Arguments to bash executable not being processed?

jao@cheese:~/git/marcel$ bash -i less README.md
Missing filename ("less --help" for help)
M jao@cheese:~/git/marcel$ bash -i ls *.md
bin  experiments  notes  README.md  src  test
M jao@cheese:~/git/marcel$ bash -i which which
Escaped command failed with exit code 1: which which
None

----------------------------------------------------------------------

FIXED

13. Tab completion for op isn't working after the first op in a pipeline

----------------------------------------------------------------------

FIXED

14. Tab expansion for files doesn't work if path starts with ~

----------------------------------------------------------------------

FIXED

15. File expansion not working for path beginning with ~/

E.g.

  M jao@cheese:~/git/marcel/src/marcel$ ls ~/ac

(There are two files whose names start with "ac")

----------------------------------------------------------------------

FIXED

16. Permission error on rm of directory crashes shell

M jao@cheese:/tmp$ rm rd
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 88, in <module>
    Main().run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 58, in run
    Main.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 70, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 36, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 209, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 51, in receive
    Rm.remove(root)
  File "/home/jao/git/marcel/src/marcel/op/rm.py", line 67, in remove
    shutil.rmtree(root)
  File "/usr/lib/python3.7/shutil.py", line 498, in rmtree
    onerror(os.rmdir, path, sys.exc_info())
  File "/usr/lib/python3.7/shutil.py", line 496, in rmtree
    os.rmdir(path)
PermissionError: [Errno 1] Operation not permitted: '/tmp/rd'

----------------------------------------------------------------------

FIXED

18. Following restart, multilines history is wrong

A multiline command is recalled one line at a time.

----------------------------------------------------------------------

FIXED

19. Crash on first run of marcel if .marcel_history doesn't exist


----------------------------------------------------------------------

FIXED

20. edit op isn't working

Wasn't quite finished.


----------------------------------------------------------------------

FIXED

21. Prompt directory stuck at ~

The problem is that the value of PWD is copied into the .marcel.py
global namespace. Need to implement a Variable class, and put it in
that namespace. The Variable can then be updated by Environment.cd.

I.e., the Variable can be shared between Environment and the config
namespace, but values cannot.

----------------------------------------------------------------------

FIXED

22. Error output should be more informative

M jao@cheese:~$ gen 3 -1 | map (x: 1/x)
-1.0
Error(None)
1.0

Error(None): should identify input and op

----------------------------------------------------------------------

FIXED

25. ls causes marcel to crash

M jao@cheese:~$ ls -r snap

...
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:02   spotify/36/.local/share/icons
drwxr-xr-x   jao      jao              4096   2019 Aug 11 18:30:12   spotify/36/.local/share/icons/Adwaita
lrwxrwxrwx   jao      jao                46   2019 Aug 11 18:30:02   spotify/36/.local/share/icons/Adwaita/16x16 -> /snap/spotify/36/usr/share/icons/Adwaita/16x16
drwxr-xr-x   root     root              965   2019 Jul 17 13:34:47   spotify/36/.local/share/icons/Adwaita/16x16/actions
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 111, in receive
    self.visit(root, 0, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 128, in visit
    self.visit(file, level + 1, base)
  [Previous line repeated 6 more times]
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 124, in visit
    self.send_path(root, base)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 138, in send_path
    self.send(file)
  File "/home/jao/git/marcel/src/marcel/core.py", line 111, in send
    self.receiver.receive_input_or_error(x)
  File "/home/jao/git/marcel/src/marcel/core.py", line 126, in receive_input_or_error
    self.receive(normalize_output(x))
  File "/home/jao/git/marcel/src/marcel/op/out.py", line 78, in receive
    out = out.render_full(self.color_scheme())
  File "/home/jao/git/marcel/src/marcel/object/file.py", line 62, in render_full
    line[-1] = colorize(line[-1], self._highlight_color(self, color_scheme))
  File "/home/jao/git/marcel/src/marcel/util.py", line 88, in colorize
    1 if color.bold else 0,
AttributeError: 'str' object has no attribute 'bold'


----------------------------------------------------------------------

FIXED

26. Symlink target always displayed as absolute

It should be displayed however it is stored. 

marcel:

    M jao@cheese:/usr/bin$ ls xzcat
    lrwxrwxrwx   root     root                2   2019 Jan 27 20:09:34   /usr/bin/xzcat -> /usr/bin/xz

bash:

    jao@cheese:/usr/bin$ ls -l xzcat
    lrwxrwxrwx 1 root root 2 Jan 27  2019 xzcat -> xz

----------------------------------------------------------------------

FIXED

27. Shell crashes on some pathlib operations if current dir does not exist

cd from current dir:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/cd.py", line 45, in receive
    dir = self.directory.expanduser().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1151, in resolve
    s = self._flavour.resolve(self, strict=strict)
  File "/usr/lib/python3.7/pathlib.py", line 354, in resolve
    base = '' if path.is_absolute() else os.getcwd()
FileNotFoundError: [Errno 2] No such file or directory


Start marcel from dir that was deleted:

Original exception was:
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 121, in <module>
    MAIN = Main()
  File "/home/jao/git/marcel/src/marcel/main.py", line 59, in __init__
    self.env = marcel.env.Environment(config_path)
  File "/home/jao/git/marcel/src/marcel/env.py", line 19, in __init__
    self._current_dir = pathlib.Path.cwd().resolve()
  File "/usr/lib/python3.7/pathlib.py", line 1064, in cwd
    return cls(os.getcwd())
FileNotFoundError: [Errno 2] No such file or directory


----------------------------------------------------------------------

FIXED

28. Hang on command with extra )

The last command hangs when an extra ) is added to the end.

M jao@cheese:/tmp/test$ ls
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:51   .
drwxr-xr-x   jao      jao              4096   2020 Mar 17 12:50:30   d
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   lf
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sd -> /tmp/test/d
lrwxrwxrwx   jao      jao                11   2020 Mar 17 12:50:30   sf -> /tmp/test/f
M jao@cheese:/tmp/test$ ls f g
-rw-r--r--   jao      jao                 2   2020 Mar 17 12:50:30   /tmp/test/f
-rw-r--r--   jao      jao                 5   2020 Mar 17 12:50:51   /tmp/test/g
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size))
('f', 2)
('g', 5)
M jao@cheese:/tmp/test$ ls f g | map (f: (f.name, f.size)))
^C

----------------------------------------------------------------------

FIXED

29. Fork execution of ls is broken

Remote:

    M jao@cheese:~$ @jao [ ls /home/jao ]
    M jao@cheese:~$ 

No output at all.

Local:

    M jao@cheese:~$ @1 [ ls /home/jao ]
    Traceback (most recent call last):
      File "/home/jao/git/marcel/src/marcel/main.py", line 122, in <module>
        MAIN.run()
      File "/home/jao/git/marcel/src/marcel/main.py", line 77, in run
        self.run_command(line)
      File "/home/jao/git/marcel/src/marcel/main.py", line 89, in run_command
        Command(pipeline).execute()
      File "/home/jao/git/marcel/src/marcel/main.py", line 38, in execute
        self.pipeline.setup_2()
      File "/home/jao/git/marcel/src/marcel/core.py", line 228, in setup_2
        op.setup_2()
      File "/home/jao/git/marcel/src/marcel/op/fork.py", line 76, in setup_2
        pipeline_copy.setup_1()
      File "/home/jao/git/marcel/src/marcel/core.py", line 217, in setup_1
        op.setup_1()
      File "/home/jao/git/marcel/src/marcel/op/ls.py", line 93, in setup_1
        super().setup_1()
      File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 35, in setup_1
        self.current_dir = self.env().pwd()
    AttributeError: 'GlobalState' object has no attribute 'env'

----------------------------------------------------------------------

FIXED

30. cd broken

M jao@cheese:~/git/marcel$ cd
Cannot cd into /home/jao/git/marcel/~. Directory does not exist.

----------------------------------------------------------------------

FIXED

31. ls /no/such/path appears to work

/no/such/path evaluates to an empty root, so the command is basically
"ls" and we get the files in the current directory.

----------------------------------------------------------------------

FIXED

32. ls crashes shell on PermissionError

M jao@cheese:~/git/marcel$ ls ~/.dbus/session-bus 
drwx------   root     root             4096   2019 Mar 28 23:45:10   .
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 126, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 81, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 93, in run_command
    Command(pipeline).execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 39, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 233, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/filenames.py", line 28, in receive
    self.action(root)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 120, in action
    self.visit(source, 0)
  File "/home/jao/git/marcel/src/marcel/op/ls.py", line 127, in visit
    for file in sorted(root.iterdir()):
  File "/usr/lib/python3.7/pathlib.py", line 1090, in iterdir
    for name in self._accessor.listdir(self):
PermissionError: [Errno 13] Permission denied: '/home/jao/.dbus/session-bus'


----------------------------------------------------------------------

FIXED

33. > in command line doesn't work

M jao@cheese:~/git/marcel$ git diff > /tmp/m.diff
Error(error: Could not access '>')



----------------------------------------------------------------------

FIXED

35. Completed jobs accumulate in jobs output

JobControl.jobs shouldn't be exposed directly. Go through a method
that calls remove_completed.

----------------------------------------------------------------------

FIXED

36. Duplicated output when grep is invoked

This is odd:

    M jao@cheese:~/git/marcel/test$ echo hello
    hello
    M jao@cheese:~/git/marcel/test$ echo hello | grep hello
    hello
    hello


----------------------------------------------------------------------

FIXED

37. kill op only kills

It ignores the signal, and just kills the command. What is the correct
behavior? kill is implemented by SIGTERM, not SIGTERM, as usual. Maybe
SIGTERM would work? Haven't tried it. If SIGTERM works instead of
SIGKILL, then switch to it, and have the kill op work consistently
with bash.

----------------------------------------------------------------------

FIXED

38. Wildcard not working

M jao@cheese:~$ grep MiniMachete /var/log/syslog*
Error(grep: /var/log/syslog*: No such file or directory)

----------------------------------------------------------------------

FIXED

39. Incorrect wrapping of help text

From red.DETAILS:

'''
...
If this sequence is piped to this invocation of {red}:

    red . + . +

then groups are defined using the first and third values, {(1, 10), (1, 11), (2, 20), (3, 30)}.
The output would be:

    (1, 11, 10, 300)
...
'''

Formatted:

If this sequence is piped to this invocation of red:

    red . + . +

then groups are defined using the first and third values, (1, 10), (1, 11), (2, 20), (3, 30). The output would be:

    (1, 11, 10, 300)


Why isn't the "then groups ..." text wrapped?

----------------------------------------------------------------------

40. Unknown cluster name is assumed to be an int

M jao@cheese:~/git/marcel/test$ @local [ ps | select (p: 'python' in p.commandline) ]
Process Process-3:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/usr/lib/python3.7/multiprocessing/process.py", line 99, in run
    self._target(*self._args, **self._kwargs)
  File "/home/jao/git/marcel/src/marcel/job.py", line 130, in run_command
    env_vars = command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 40, in execute
    self.pipeline.setup_1()
  File "/home/jao/git/marcel/src/marcel/core.py", line 276, in setup_1
    op.setup_1()
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 45, in setup_1
    self.impl = Remote(self) if cluster else Local(self)
  File "/home/jao/git/marcel/src/marcel/op/fork.py", line 176, in __init__
    op.fork_spec = int(op.fork_spec)
ValueError: invalid literal for int() with base 10: 'local'


----------------------------------------------------------------------

FIXED

41. Blank line should not be ignored on continuation line

Blank lines are ignored, which is fine. But if the blank line is a
continuation line, then the current command should be ended and executed.
Cleanup:

----------------------------------------------------------------------

NOT A BUG: echo doesn't accept piped input. And ... | xargs echo works.

42. Errors piped to executables are broken

Odd results:

M jao@cheese:/etc/sysctl.d$ gen 3 | map (x: 1/(1-x)) | echo
Error(map(x: 1/(1-x)) failed on (1,): division by zero)

----------------------------------------------------------------------

NOT A BUG: Yes, crashing the shell is fine. Bad markup is a bug in source, users shouldn't see it.

43. Bad markup shouldn't crash the shell

And probably don't throw Exception.

M jao@cheese:~$ help configuration
Traceback (most recent call last):
  File "/home/jao/git/marcel/src/marcel/main.py", line 159, in <module>
    MAIN.run()
  File "/home/jao/git/marcel/src/marcel/main.py", line 90, in run
    self.run_command(line)
  File "/home/jao/git/marcel/src/marcel/main.py", line 107, in run_command
    command.execute()
  File "/home/jao/git/marcel/src/marcel/main.py", line 41, in execute
    self.pipeline.receive(None)
  File "/home/jao/git/marcel/src/marcel/core.py", line 292, in receive
    self.first_op.receive(x)
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 52, in receive
    help_text = Help.op_help(op_module) if op_module else self.topic_help()
  File "/home/jao/git/marcel/src/marcel/op/help.py", line 81, in topic_help
    return formatter.format(help_text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 298, in format
    blocks = self.find_explicit_paragraph_boundaries(text)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 321, in find_explicit_paragraph_boundaries
    blocks.append(Paragraph(self, text[open:close]))
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 208, in __init__
    self.paragraph_markup = ParagraphMarkup(markup)
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 85, in __init__
    self.parse_paragraph_formatting()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 91, in parse_paragraph_formatting
    self.raise_invalid_formatting_exception()
  File "/home/jao/git/marcel/src/marcel/helpformatter.py", line 74, in raise_invalid_formatting_exception
    raise Exception(f'Invalid formatting specification: {self.text}')
Exception: Invalid formatting specification: {process_...}


----------------------------------------------------------------------

FIXED

44. \ in help text doesn't work.

\\ in help_command.py: Need space between \\ and } or crash. Also, not
even \\ is showing up.
